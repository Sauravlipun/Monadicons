<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monadicons Social</title>
<style>
  :root{
    --bg1:#12002b;
    --bg2:#240046;
    --accent1:#7b2ff7;
    --accent2:#f107a3;
    --card:#1c1330;
    --muted:#bfb8d9;
  }
  html,body { height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; color:#fff; background:linear-gradient(135deg,var(--bg1),var(--bg2)); }
  #bgCanvas{ position:fixed; inset:0; width:100%; height:100%; z-index:-2; }

  .wrap{ max-width:1230px; margin:18px auto; padding:18px; box-sizing:border-box; }

  .header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .brand { display:flex; gap:12px; align-items:center; }
  .logo{ width:52px;height:52px;border-radius:10px; display:grid;place-items:center;font-weight:700;
         background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; font-size:20px; }
  .title{font-size:20px; font-weight:700; letter-spacing:0.6px;}
  .nav { display:flex; gap:10px; align-items:center; }
  .btn { background:linear-gradient(90deg,var(--accent1),var(--accent2)); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; text-decoration:none; }

  .section-title{ margin-top:12px; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
  .carousel { margin:14px 0; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border-radius:12px; padding:14px; display:flex; align-items:center; gap:12px; justify-content:center; position:relative; min-height:180px; box-shadow:0 6px 30px rgba(11,3,30,0.45); }
  .carousel-inner { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .carousel-img { max-height:140px; max-width:100%; border-radius:10px; object-fit:cover; cursor:pointer; box-shadow:0 8px 30px rgba(16,6,40,0.6); transition:transform .18s ease; }
  .carousel-img:active{ transform:scale(.995); }
  .carousel-controls{ position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; pointer-events:none; }
  .carousel-controls button{ pointer-events:all; background:rgba(0,0,0,0.45); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; margin:0 10px; }
  .carousel-votes{ color:var(--muted); font-size:13px; }

  .grid { display:grid; grid-template-columns: 1fr 350px; gap:18px; align-items:start; }
  @media (max-width:1000px){ .grid{ grid-template-columns: 1fr; } }

  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(9,3,36,0.55); }
  .upload-row { display:flex; gap:10px; align-items:center; }
  label{ display:block; font-size:13px; color:var(--muted); margin-top:8px; margin-bottom:6px; }
  input[type="text"], textarea, input[type="file"]{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff; outline:none; box-sizing:border-box; font-size:14px; }
  textarea{ resize:vertical; min-height:56px; }
  .upload-actions { display:flex; gap:8px; align-items:center; margin-top:10px; }

  .gallery {
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
    max-height: calc(100vh - 420px);
    overflow:auto;
    padding-right:6px;
  }
  @media (max-width:1280px){ .gallery{ grid-template-columns: repeat(4,1fr); } }
  @media (max-width:900px){ .gallery{ grid-template-columns: repeat(3,1fr); max-height: 420px; } }
  @media (max-width:600px){ .gallery{ grid-template-columns: repeat(2,1fr); max-height: 380px; } }

  .thumb {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
    border-radius:10px;
    padding:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
    text-align:center;
    cursor:default;
    transition: transform .12s ease;
  }
  .thumb:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(5,1,25,0.6); }
  .thumb img { width:100%; height:100px; object-fit:cover; border-radius:8px; display:block; }
  .thumb .meta { width:100%; }
  .thumb h4{ margin:0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .thumb p{ margin:0; font-size:11px; color:var(--muted); height:28px; overflow:hidden; text-overflow:ellipsis; }

  .vote-row{ display:flex; gap:6px; align-items:center; justify-content:center; margin-top:4px; flex-wrap:wrap; }
  .vote-btn { background:linear-gradient(90deg,var(--accent1),var(--accent2)); border:none; color:#fff; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; display:inline-flex; gap:6px; align-items:center; }
  .small-btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; }
  .danger-btn{ background:transparent; border:1px solid rgba(255,70,90,0.15); color:#ff7070; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; }

  .sidebar { display:flex; flex-direction:column; gap:12px; }
  .leaderboard { padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); }
  .leaderboard h3{ margin:0 0 8px 0; font-size:15px; }
  .leaderboard table{ width:100%; border-collapse:collapse; color:var(--muted); font-size:13px; }
  .leaderboard td, .leaderboard th{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; }
  .leaderboard th{ color:#fff; font-size:12px; font-weight:700; }

  .chat { padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); }
  .chat .messages { max-height:180px; overflow:auto; border-radius:8px; padding:8px; background:rgba(0,0,0,0.05); margin-bottom:8px; }
  .chat .msg { padding:6px 8px; border-radius:8px; background:rgba(123,47,247,0.06); margin-bottom:8px; font-size:13px; }
  .chat-row{ display:flex; gap:8px; }

  .footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; padding-bottom:30px; }

  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); z-index:999; }
  .modal .content { max-width:880px; max-height:90vh; width:calc(100% - 48px); padding:18px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); display:flex; flex-direction:column; gap:12px; align-items:center; }
  .modal img{ max-width:100%; max-height:72vh; object-fit:contain; border-radius:10px; }

  .muted{ color:var(--muted); font-size:13px; }
  a.small-link{ color:var(--accent1); text-decoration:none; font-weight:600; }

  /* toast (undo) */
  .toast {
    position:fixed;
    left:18px;
    bottom:18px;
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#fff;
    padding:12px 14px;
    border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,0.5);
    display:flex;
    gap:12px;
    align-items:center;
    z-index:1200;
    min-width:220px;
  }
  .toast .msg{ flex:1; font-weight:600; font-size:14px; }
  .toast .undo{ background:rgba(255,255,255,0.15); border:none; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
  .toast .bar{ position:absolute; left:0; bottom:0; height:4px; background:rgba(255,255,255,0.35); border-bottom-left-radius:10px; border-bottom-right-radius:10px; }
  
  /* confirm modal */
  .confirm-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:1300; }
  .confirm-box { width:420px; max-width:90%; background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06)); padding:18px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.6); color:#fff; }
  .confirm-box p{ margin:0 0 12px 0; color:var(--muted); }
  .confirm-actions{ display:flex; gap:8px; justify-content:flex-end; }
  .confirm-actions .btn{ padding:8px 12px; }
  .confirm-actions .cancel{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); border-radius:8px; padding:8px 12px; cursor:pointer; }
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas>

<div class="wrap">
  <div class="header">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div class="title">Monadicons Social</div>
        <div class="muted" style="font-size:12px">Showcase ‚Ä¢ Vote ‚Ä¢ Share</div>
      </div>
    </div>
    <div class="nav">
      <a class="btn" href="index.html">‚Üê Back to Home</a>
    </div>
  </div>

  <div class="section-title">Featured Artworks</div>
  <div class="carousel" id="carousel">
    <div class="carousel-controls">
      <button id="prevBtn" aria-label="previous">‚ùÆ</button>
      <button id="nextBtn" aria-label="next">‚ùØ</button>
    </div>
    <div class="carousel-inner">
      <img id="carouselImg" class="carousel-img" src="" alt="Featured">
      <div id="carouselVotes" class="carousel-votes muted">‚Äî</div>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="vote-btn" id="carouselVoteThumb">üëç Vote</button>
        <button class="small-btn" id="carouselOpen">Open</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: gallery + upload -->
    <div class="left">
      <div class="card upload-card">
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="flex:1">
            <label for="username">Name / Handle</label>
            <input id="username" type="text" placeholder="e.g. @artist">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Short description..."></textarea>
            <label for="file">Image</label>
            <input id="file" type="file" accept="image/*">
            <div class="upload-actions">
              <button id="uploadBtn" class="btn">Upload & Showcase</button>
              <button id="clearAllBtn" class="small-btn" title="Remove all artworks">Clear all artworks</button>
              <div class="muted" style="font-size:12px; margin-left:8px;">Tip: upload clear PNG / JPG</div>
            </div>
          </div>
          <div style="width:140px; text-align:center;">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">Top creators</div>
            <div id="miniTop" style="background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03)); padding:8px; border-radius:8px; font-size:13px;"></div>
          </div>
        </div>
      </div>

      <div class="section-title" style="margin-top:16px;">Community Gallery</div>
      <div id="gallery" class="gallery" aria-live="polite"></div>
    </div>

    <!-- RIGHT: sidebar (leaderboard + chat) -->
    <aside class="sidebar">
      <div class="card leaderboard">
        <h3>Top 10 Creators (Free Mon tokens!)</h3>
        <table id="leaderboard" aria-hidden="false">
          <thead><tr><th>#</th><th>User</th><th>Votes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card chat">
        <h3>Community Chat</h3>
        <div id="chatMessages" class="messages" aria-live="polite"></div>
        <div style="display:flex;gap:8px; margin-top:8px;">
          <input id="chatInput" placeholder="Type a message..." style="flex:1" />
          <select id="emojiSelect" style="width:70px;">
            <option>üòÄ</option><option>üòç</option><option>üî•</option><option>üëç</option><option>üé®</option><option>üíñ</option>
          </select>
          <button id="sendMsg" class="btn">Send</button>
          <button id="clearChatBtn" class="small-btn" title="Clear chat history">Clear Chat</button>
        </div>
      </div>
    </aside>
  </div>

  <div class="footer">Powered by Monadicons ¬©2025</div>
</div>

<!-- preview modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="content" role="document">
    <div style="width:100%; display:flex; justify-content:flex-end;">
      <button id="closeModal" class="small-btn">Close</button>
    </div>
    <img id="modalImg" src="" alt="Artwork preview" />
    <div style="display:flex;gap:10px; align-items:center; width:100%; justify-content:center;">
      <button id="downloadBtn" class="vote-btn">Download</button>
      <button id="shareXBtn" class="small-btn">Share on X</button>
      <button id="deleteModalBtn" class="danger-btn">Delete Artwork</button>
    </div>
  </div>
</div>

<!-- confirm modal -->
<div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-box" role="document" aria-labelledby="confirmTitle" aria-describedby="confirmDesc">
    <h3 id="confirmTitle" style="margin:0 0 8px 0;">Confirm action</h3>
    <p id="confirmDesc">Are you sure?</p>
    <div class="confirm-actions">
      <button id="confirmCancel" class="cancel">Cancel</button>
      <button id="confirmOk" class="btn">Confirm</button>
    </div>
  </div>
</div>

<!-- toast for undo -->
<div id="toastContainer" style="position:fixed;left:18px;bottom:18px;z-index:1400"></div>

<script>
/* ----------------------------
   Particle background
   ---------------------------- */
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
const particles = [];
const PARTICLE_COUNT = Math.round((W*H)/70000) + 40;
for(let i=0;i<PARTICLE_COUNT;i++){
  particles.push({
    x: Math.random()*W,
    y: Math.random()*H,
    r: Math.random()*1.6 + 0.6,
    vx: (Math.random()-0.5)*0.25,
    vy: (Math.random()-0.5)*0.25
  });
}
function bgAnim(){
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'rgba(36,0,70,0.10)');
  g.addColorStop(1,'rgba(18,0,43,0.12)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);
  particles.forEach(p=>{
    p.x += p.vx; p.y += p.vy;
    if(p.x < -10) p.x = W + 10;
    if(p.x > W + 10) p.x = -10;
    if(p.y < -10) p.y = H + 10;
    if(p.y > H + 10) p.y = -10;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = 'rgba(139,61,255,0.09)';
    ctx.fill();
  });
  requestAnimationFrame(bgAnim);
}
bgAnim();
addEventListener('resize',()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; });

/* ----------------------------
   App core + confirmation + undo
   ---------------------------- */
const galleryEl = document.getElementById('gallery');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('file');
const usernameEl = document.getElementById('username');
const descEl = document.getElementById('description');

const leaderboardBody = document.querySelector('#leaderboard tbody');
const miniTop = document.getElementById('miniTop');

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendMsg = document.getElementById('sendMsg');
const emojiSelect = document.getElementById('emojiSelect');

const carouselImg = document.getElementById('carouselImg');
const carouselVotes = document.getElementById('carouselVotes');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const carouselVoteThumb = document.getElementById('carouselVoteThumb');
const carouselOpen = document.getElementById('carouselOpen');

const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const closeModalBtn = document.getElementById('closeModal');
const downloadBtn = document.getElementById('downloadBtn');
const shareXBtn = document.getElementById('shareXBtn');
const deleteModalBtn = document.getElementById('deleteModalBtn');

const clearAllBtn = document.getElementById('clearAllBtn');
const clearChatBtn = document.getElementById('clearChatBtn');

const toastContainer = document.getElementById('toastContainer');

const confirmModal = document.getElementById('confirmModal');
const confirmDesc = document.getElementById('confirmDesc');
const confirmOk = document.getElementById('confirmOk');
const confirmCancel = document.getElementById('confirmCancel');

let artworks = JSON.parse(localStorage.getItem('artworks') || '[]'); // array of {username,description,data,votes:{}}
let messages = JSON.parse(localStorage.getItem('messages') || '[]');

let featuredIndex = 0;
let featuredArtworks = [];
let modalCurrentIndex = -1;

/* Undo state */
let lastAction = null; // { type:'delete'|'clearAll'|'clearChat', payload:..., timeoutId }
const UNDO_MS = 8000;

/* Save helper */
function save(){ localStorage.setItem('artworks', JSON.stringify(artworks)); }

/* Leaderboard computation */
function computeLeaderboard(){
  const map = {};
  artworks.forEach(a=>{
    const total = Object.values(a.votes || {}).reduce((s,v)=>s+v,0);
    map[a.username] = (map[a.username]||0) + total;
  });
  const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  return { sorted, map };
}

/* Update leaderboard UI */
function updateLeaderboard(){
  const { sorted } = computeLeaderboard();
  const top10 = sorted.slice(0,10);
  leaderboardBody.innerHTML = '';
  top10.forEach(([user,score], i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:30px">${i+1}</td><td>${escapeHtml(user)}</td><td style="width:70px">${score}</td>`;
    leaderboardBody.appendChild(tr);
  });
  miniTop.innerHTML = top10.slice(0,3).map(([u,s])=>`${escapeHtml(u)}: ${s}`).join('<br>') || '<span class="muted">No activity yet</span>';
  return top10.map(t=>t[0]); // usernames
}

/* Update featured - only from top10 creators, pick top artworks among them */
function updateFeatured(){
  const topUsernames = computeLeaderboard().sorted.slice(0,10).map(x=>x[0]);
  const candidate = artworks.filter(a => topUsernames.includes(a.username));
  featuredArtworks = candidate.slice().sort((a,b)=>{
    const ta = Object.values(a.votes||{}).reduce((s,v)=>s+v,0);
    const tb = Object.values(b.votes||{}).reduce((s,v)=>s+v,0);
    return tb - ta;
  }).slice(0,3);
  if(featuredArtworks.length === 0){
    carouselImg.src = '';
    carouselVotes.textContent = '--';
    carouselImg.alt = '';
    return;
  }
  if(featuredIndex >= featuredArtworks.length) featuredIndex = 0;
  const art = featuredArtworks[featuredIndex];
  carouselImg.src = art.data;
  carouselImg.alt = art.description || art.username;
  const votes = art.votes || {};
  carouselVotes.textContent = `üëç ${(votes['üëç']||0)}  ‚Ä¢  üòç ${(votes['üòç']||0)}  ‚Ä¢  üé® ${(votes['üé®']||0)}`;
}

/* Render gallery */
function renderGallery(){
  galleryEl.innerHTML = '';
  const items = [...artworks].slice().reverse();
  items.forEach((item, revIdx) => {
    const index = artworks.length - 1 - revIdx; // real index in artworks array
    const card = document.createElement('div');
    card.className = 'thumb';
    card.innerHTML = `
      <img src="${item.data}" alt="${escapeHtml(item.description)}" />
      <div class="meta">
        <h4 title="${escapeHtml(item.username)}">${escapeHtml(item.username)}</h4>
        <p title="${escapeHtml(item.description)}">${escapeHtml(item.description)}</p>
      </div>
      <div class="vote-row" aria-hidden="false">
        <button class="vote-btn" onclick="handleVote(event, ${index}, 'üëç')">üëç ${(item.votes['üëç']||0)}</button>
        <button class="vote-btn" onclick="handleVote(event, ${index}, 'üòç')">üòç ${(item.votes['üòç']||0)}</button>
        <button class="vote-btn" onclick="handleVote(event, ${index}, 'üé®')">üé® ${(item.votes['üé®']||0)}</button>
      </div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button class="small-btn" onclick="handleDownload(event, ${index})">Download</button>
        <button class="small-btn" onclick="handleShareX(event, ${index})">Share X</button>
        <button class="danger-btn" onclick="handleDelete(event, ${index})">Delete</button>
      </div>
    `;
    card.addEventListener('click', (e)=>{
      const target = e.target;
      if (target.closest('.vote-btn') || target.closest('.small-btn') || target.closest('.danger-btn')) return;
      openModal(index);
    });
    galleryEl.appendChild(card);
  });
  updateLeaderboard();
  updateFeatured();
}

/* Handlers to stop propagation */
function handleVote(e, index, emoji){ e.stopPropagation(); vote(index, emoji); }
function handleDownload(e, index){ e.stopPropagation(); downloadArt(index); }
function handleShareX(e, index){ e.stopPropagation(); shareX(index); }
function handleDelete(e, index){ e.stopPropagation(); showConfirmFor('delete', `Delete this artwork by "${escapeHtml(artworks[index].username)}"?`, { index }); }

/* Voting */
function vote(index, emoji){
  if(!artworks[index].votes) artworks[index].votes = {};
  artworks[index].votes[emoji] = (artworks[index].votes[emoji]||0) + 1;
  save();
  renderGallery();
  updateFeatured();
}

/* Upload */
uploadBtn.addEventListener('click', ()=>{
  const username = (usernameEl.value || 'Anonymous').trim();
  const description = (descEl.value || '').trim();
  const file = fileInput.files[0];
  if(!file){
    alert('Please select an image to upload.');
    return;
  }
  const reader = new FileReader();
  reader.onload = (e)=>{
    artworks.push({ username, description, data: e.target.result, votes: {} });
    save();
    renderGallery();
    usernameEl.value=''; descEl.value=''; fileInput.value='';
  };
  reader.readAsDataURL(file);
});

/* Delete (permanent) with undo snapshot - called after confirmation */
function performDeleteAt(index){
  if(index < 0 || index >= artworks.length) return;
  const item = artworks[index];
  // set undo state and remove item
  setLastActionAndToast({ type:'delete', payload:{ item, index }});
  artworks.splice(index,1);
  save();
  renderGallery();
}

/* Clear all artworks - confirmation then perform */
function performClearAll(){
  if(artworks.length === 0) return;
  setLastActionAndToast({ type:'clearAll', payload:{ items: artworks.slice() }});
  artworks = [];
  save();
  renderGallery();
}

/* Clear chat */
function performClearChat(){
  if(messages.length === 0) return;
  setLastActionAndToast({ type:'clearChat', payload:{ messages: messages.slice() }});
  messages = [];
  localStorage.setItem('messages', JSON.stringify(messages));
  renderMessages();
}

/* download & share */
function downloadArt(index){
  const a = document.createElement('a');
  a.href = artworks[index].data;
  a.download = `${(artworks[index].username||'art')}-monadicons.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function shareX(index){
  const text = encodeURIComponent(`${artworks[index].description || ''} ‚Äî by ${artworks[index].username || 'Anonymous'}`);
  const url = encodeURIComponent(artworks[index].data);
  const shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
  window.open(shareUrl, '_blank', 'noopener');
}

/* modal preview */
function openModal(index){
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  modalImg.src = artworks[index].data;
  modalCurrentIndex = index;
  downloadBtn.onclick = ()=> downloadArt(index);
  shareXBtn.onclick = ()=> shareX(index);
  // delete action should use confirm modal
  deleteModalBtn.onclick = ()=> showConfirmFor('delete', `Delete this artwork by "${escapeHtml(artworks[index].username)}"?`, { index });
}
closeModalBtn.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
window.addEventListener('click', (e)=>{ if(e.target === modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

/* Chat */
function renderMessages(){
  chatMessages.innerHTML = '';
  messages.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'msg';
    div.textContent = m.text;
    chatMessages.appendChild(div);
  });
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
sendMsg.addEventListener('click', ()=>{
  const val = chatInput.value.trim();
  if(!val) return;
  messages.push({ text: val });
  localStorage.setItem('messages', JSON.stringify(messages));
  chatInput.value = '';
  renderMessages();
});
chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMsg.click(); });
emojiSelect.addEventListener('change', ()=>{ chatInput.value += emojiSelect.value; chatInput.focus(); });

/* clear chat confirm */
document.getElementById('clearChatBtn').addEventListener('click', ()=> {
  showConfirmFor('clearChat', 'Clear chat history? This cannot be undone (but you will have an Undo option).', {});
});

/* clear all confirm */
clearAllBtn.addEventListener('click', ()=> {
  showConfirmFor('clearAll', 'Clear ALL artworks? This will remove every uploaded artwork (Undo available).', {});
});

/* carousel controls & auto rotate */
prevBtn.addEventListener('click', ()=>{
  if(featuredArtworks.length === 0) return;
  featuredIndex = (featuredIndex - 1 + featuredArtworks.length) % featuredArtworks.length;
  updateFeatured();
});
nextBtn.addEventListener('click', ()=>{
  if(featuredArtworks.length === 0) return;
  featuredIndex = (featuredIndex + 1) % featuredArtworks.length;
  updateFeatured();
});
let carouselInterval = setInterval(()=>{ if(featuredArtworks.length>0){ featuredIndex = (featuredIndex + 1) % featuredArtworks.length; updateFeatured(); } }, 5000);

/* carousel vote & open */
carouselVoteThumb.addEventListener('click', ()=>{
  if(!featuredArtworks.length) return;
  const current = featuredArtworks[featuredIndex];
  const idx = artworks.indexOf(current);
  if(idx >= 0) vote(idx, 'üëç');
});
carouselOpen.addEventListener('click', ()=>{
  if(!featuredArtworks.length) return;
  const current = featuredArtworks[featuredIndex];
  const idx = artworks.indexOf(current);
  if(idx >= 0) openModal(idx);
});

/* ============================
   Confirmation modal helpers
   ============================ */
let confirmResolve = null;
function showConfirmFor(type, message, payload){
  confirmDesc.innerHTML = message;
  confirmModal.style.display = 'flex';
  confirmModal.setAttribute('aria-hidden','false');

  // return a promise resolved when user confirms/cancels
  return new Promise((resolve) => {
    confirmResolve = (ok) => {
      confirmModal.style.display = 'none';
      confirmModal.setAttribute('aria-hidden','true');
      confirmResolve = null;
      if(ok){
        // perform the requested action
        if(type === 'delete'){
          performDeleteAt(payload.index);
        } else if(type === 'clearAll'){
          performClearAll();
        } else if(type === 'clearChat'){
          performClearChat();
        }
      }
      resolve(ok);
    };
  });
}
confirmOk.addEventListener('click', ()=>{ if(confirmResolve) confirmResolve(true); });
confirmCancel.addEventListener('click', ()=>{ if(confirmResolve) confirmResolve(false); });
confirmModal.addEventListener('click', (e)=>{ if(e.target === confirmModal){ if(confirmResolve) confirmResolve(false); } });

/* ============================
   Undo toast / state helpers
   ============================ */
function setLastActionAndToast(actionObj){
  // finalize any previous pending toast (we remove the timeout so it cannot be undone anymore)
  if(lastAction && lastAction.timeoutId){
    clearTimeout(lastAction.timeoutId);
    lastAction = null;
    // remove existing toast UI immediately
    toastContainer.innerHTML = '';
  }

  lastAction = {
    ...actionObj,
    createdAt: Date.now(),
    timeoutId: null
  };
  showUndoToastFor(lastAction);
}

function showUndoToastFor(action){
  toastContainer.innerHTML = '';
  const toast = document.createElement('div');
  toast.className = 'toast';
  const msg = document.createElement('div');
  msg.className = 'msg';
  if(action.type === 'delete') msg.textContent = 'Artwork deleted';
  else if(action.type === 'clearAll') msg.textContent = 'All artworks cleared';
  else if(action.type === 'clearChat') msg.textContent = 'Chat cleared';
  else msg.textContent = 'Action performed';

  const undoBtn = document.createElement('button');
  undoBtn.className = 'undo';
  undoBtn.textContent = 'Undo';

  const bar = document.createElement('div');
  bar.className = 'bar';
  bar.style.width = '100%';
  bar.style.transition = `width ${UNDO_MS}ms linear`;

  toast.appendChild(msg);
  toast.appendChild(undoBtn);
  toastContainer.appendChild(toast);
  toastContainer.appendChild(bar);
  // start progress bar animation
  setTimeout(()=>{ bar.style.width = '0%'; }, 20);

  // schedule finalization
  const timeoutId = setTimeout(()=>{
    lastAction = null;
    toastContainer.innerHTML = '';
  }, UNDO_MS);
  lastAction.timeoutId = timeoutId;

  undoBtn.onclick = ()=> {
    if(!lastAction) return;
    clearTimeout(lastAction.timeoutId);
    // reverse
    if(lastAction.type === 'delete'){
      const { item, index } = lastAction.payload;
      const insertAt = Math.min(Math.max(index,0), artworks.length);
      artworks.splice(insertAt,0,item);
      save();
      renderGallery();
      updateFeatured();
    } else if(lastAction.type === 'clearAll'){
      artworks = lastAction.payload.items.slice();
      save();
      renderGallery();
      updateFeatured();
    } else if(lastAction.type === 'clearChat'){
      messages = lastAction.payload.messages.slice();
      localStorage.setItem('messages', JSON.stringify(messages));
      renderMessages();
    }
    lastAction = null;
    toastContainer.innerHTML = '';
  };
}

/* Keyboard undo: Ctrl/Cmd + Z */
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z'){
    if(lastAction){
      // simulate clicking undo button
      const undoBtn = toastContainer.querySelector('.undo');
      if(undoBtn){
        undoBtn.click();
      }
    }
  }
});

/* Utility: escape HTML */
function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* Initialization */
function init(){
  artworks = artworks.map(a => ({ username: a.username||'Anonymous', description: a.description||'', data: a.data, votes: a.votes||{} }));
  messages = messages || [];
  save();
  renderGallery();
  renderMessages();
  updateFeatured();
}
init();

/* Expose functions used by inline onclick handlers */
window.handleVote = handleVote;
window.handleDownload = handleDownload;
window.handleShareX = handleShareX;
window.handleDelete = handleDelete;
window.openModal = openModal;
window.deleteArt = performDeleteAt;
window.vote = vote;
window.downloadArt = downloadArt;
window.shareX = shareX;
</script>
</body>
</html>
