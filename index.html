<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monadicons — Avatar studio</title>
<meta name="description" content="Generate avatars. Customize settings, preview, and download SVG/PNG." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%237C3AED'/><text x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'>M</text></svg>">

<!-- jdenticon for local generation -->
<script src="https://cdn.jsdelivr.net/npm/jdenticon@3.2.0/dist/jdenticon.min.js"></script>

<style>
:root{
  --accent:#7C3AED; --accent-2:#5B21B6; --muted:#9fb0c9; --bg-1:#071124; --bg-2:#071a2b;
  --card-bg: rgba(255,255,255,0.02);
  --glass: rgba(255,255,255,0.04);
  --gap:18px;
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial;
  color:#e6eef8;
  background:radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
  -webkit-font-smoothing:antialiased;
  padding:22px;
  transition: background .25s ease, color .2s ease;
}
.container{max-width:1180px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:20px}
h1{margin:0;font-size:20px}
.header-actions{display:flex;gap:8px;align-items:center}
.btn, .ghost, .small { cursor:pointer; border-radius:10px; padding:8px 12px; font-weight:600; border:none; outline:none }
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; box-shadow:0 8px 24px rgba(124,58,237,0.12)}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted)}
.small{padding:6px 8px;background:var(--glass);color:var(--muted);font-weight:600}
.grid{display:grid;grid-template-columns:1fr 440px;gap:var(--gap);align-items:start}
.card{background:var(--card-bg);padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
.controls label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
.row{display:flex;gap:8px;align-items:center}
.input, select, input[type="color"], input[type="number"], input[type="text"]{
  width:100%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;
}
.controls{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
.preview-box{width:100%;height:440px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.preview-box svg{width:100%;height:100%;display:block}
.preview-meta{color:var(--muted);font-size:13px;margin-top:8px;text-align:center}
.history{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.thumb{width:64px;height:64px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;cursor:pointer;background:white;display:flex;align-items:center;justify-content:center}
.switch{display:inline-flex;align-items:center;gap:8px;background:var(--glass);padding:6px;border-radius:999px}
.switch input{display:none}
footer{color:var(--muted);font-size:13px;text-align:center;margin-top:18px}

/* LIGHT THEME OVERRIDES */
body.light{
  color: #1f2937;
  background: linear-gradient(180deg,#f0f4f8,#e6eef5);
}
body.light .card{ background: white; border-color: rgba(0,0,0,0.06); color: #1f2937 }
body.light .input, body.light select { background: white; color: #111; border-color: rgba(0,0,0,0.12) }
body.light .ghost { border-color: rgba(0,0,0,0.08); color: #475569 }
body.light .preview-box { background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent) }

@media(max-width:1000px){
  .grid{grid-template-columns:1fr; }
  .preview-box{height:360px}
}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo">M</div>
      <div><h1>Monadicons</h1></div>
    </div>

    <div class="header-actions">
      <div class="switch" title="Live preview (updates as you change inputs)">
        <input id="liveToggle" type="checkbox"><label for="liveToggle" style="color:var(--muted);font-weight:600">Live</label>
      </div>
      <button id="randomBtn" class="ghost">Random</button>
      <button id="exportJSON" class="small">Export Settings</button>
      <button id="toggleTheme" class="small">Light</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: controls -->
    <div class="card controls">
      <label for="seed">Seed / Name</label>
      <input id="seed" class="input" type="text" placeholder="e.g., aurora" value="anon" />

      <label for="style">Style</label>
      <select id="style" class="input">
        <optgroup label="DiceBear">
          <option value="adventurer">adventurer</option>
          <option value="avataaars">avataaars</option>
          <option value="big-ears">big-ears</option>
          <option value="bottts">bottts</option>
          <option value="croodles">croodles</option>
          <option value="fun-emoji">fun-emoji</option>
          <option value="icons">icons</option>
          <option value="identicon">identicon</option>
          <option value="micah">micah</option>
          <option value="pixel-art-neutral">pixel-art-neutral</option>
        </optgroup>
        <optgroup label="Local">
          <option value="jdenticon">jdenticon (local)</option>
        </optgroup>
      </select>

      <div style="display:flex;gap:8px;margin-top:10px">
        <div style="flex:1">
          <label for="size">Size (px)</label>
          <input id="size" class="input" type="number" min="64" max="4096" value="512" />
        </div>
        <div style="width:150px">
          <label for="scale">Scale (%)</label>
          <input id="scale" class="input" type="number" min="50" max="200" value="100" />
        </div>
        <div style="width:150px">
          <label for="rotation">Rotation (°)</label>
          <input id="rotation" class="input" type="number" min="-180" max="180" value="0" />
        </div>
      </div>

      <label for="bgType">Background type</label>
      <select id="bgType" class="input">
        <option value="transparent">transparent</option>
        <option value="solid">solid</option>
        <option value="gradient">gradient</option>
        <option value="radial">radial</option>
        <option value="dots">dots</option>
        <option value="stripes">stripes</option>
        <option value="checker">checker</option>
        <option value="noise">noise</option>
      </select>

      <label for="bgColor">Background color</label>
      <input id="bgColor" type="color" value="#7C3AED" class="input" />

      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button id="generateBtn" class="btn">Generate (Add to history)</button>
        <button id="applyPreviewBtn" class="ghost">Apply Preview</button>
        <div style="flex:1"></div>
        <button id="clearHistory" class="small">Clear History</button>
      </div>

      <div class="toolbar" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="downloadSvg" class="ghost">Download SVG</button>
        <button id="downloadPng" class="ghost">Download PNG</button>
        <button id="copyEmbed" class="ghost">Copy Embed</button>
        <button id="shareX" class="ghost">Share X</button>
        <button id="shareDiscord" class="ghost">Share Discord</button>
      </div>

      <div style="margin-top:12px">
        <label>Presets</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="small preset" data-seed="aurora" data-style="adventurer">Aurora</button>
          <button class="small preset" data-seed="nebula" data-style="pixel-art-neutral">Nebula</button>
          <button class="small preset" data-seed="octopus" data-style="fun-emoji">Octopus</button>
          <button class="small preset" data-seed="miso" data-style="jdenticon">Miso</button>
          <button class="small" id="randomPreset">Surprise me</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>History</label>
        <div class="history" id="history"></div>
      </div>

      <div style="margin-top:12px">
        <label>Export/Save</label>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="copyJSON" class="small">Copy JSON</button>
          <button id="downloadJSON" class="small">Download JSON</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: preview -->
    <div>
      <div class="card">
        <div class="preview-box" id="previewBox">
          <div id="placeholder" style="text-align:center;color:var(--muted)">
            <div style="font-size:18px;margin-bottom:6px">Preview</div>
            <div style="font-size:13px">Configure settings on the left, then click Generate (or toggle Live)</div>
          </div>
        </div>
        <div class="preview-meta" id="previewMeta">—</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Options snapshot</div>
          <div style="color:var(--muted);font-size:13px">Copy / Share below</div>
        </div>
        <pre id="settingsOut" style="white-space:pre-wrap;word-break:break-word;background:transparent;border:none;color:var(--muted);margin-top:8px"></pre>
      </div>
    </div>
  </div>

  <footer>Powered by Monadicons • ©2025</footer>
</div>

<script>
/* ---------- Utilities ---------- */
const qs = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

function hexToRgb(hex){
  hex = (hex||'#ffffff').replace('#','');
  if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  const r = parseInt(hex.slice(0,2),16);
  const g = parseInt(hex.slice(2,4),16);
  const b = parseInt(hex.slice(4,6),16);
  return {r,g,b};
}
function mixWithWhite(hex, pct=0.6){
  const c = hexToRgb(hex);
  const r = Math.round(c.r + (255-c.r)*pct);
  const g = Math.round(c.g + (255-c.g)*pct);
  const b = Math.round(c.b + (255-c.b)*pct);
  return `rgb(${r},${g},${b})`;
}

/* ---------- Elements ---------- */
const liveToggle = qs('#liveToggle');
const seedEl = qs('#seed');
const styleEl = qs('#style');
const sizeEl = qs('#size');
const scaleEl = qs('#scale');       // percent (100)
const rotationEl = qs('#rotation');
const bgTypeEl = qs('#bgType');
const bgColorEl = qs('#bgColor');

const generateBtn = qs('#generateBtn');
const applyPreviewBtn = qs('#applyPreviewBtn');
const randomBtn = qs('#randomBtn');
const randomPreset = qs('#randomPreset');

const previewBox = qs('#previewBox');
const previewMeta = qs('#previewMeta');
const placeholder = qs('#placeholder');

const downloadSvgBtn = qs('#downloadSvg');
const downloadPngBtn = qs('#downloadPng');
const copyEmbedBtn = qs('#copyEmbed');
const shareXBtn = qs('#shareX');
const shareDiscordBtn = qs('#shareDiscord');

const historyEl = qs('#history');
const copyJSON = qs('#copyJSON');
const downloadJSON = qs('#downloadJSON');
const exportJSON = qs('#exportJSON');
const settingsOut = qs('#settingsOut');

const toggleThemeBtn = qs('#toggleTheme');

let isLight = false;

/* ---------- State ---------- */
let history = [];
const sampleSeeds = ['aurora','lumen','nova','zephyr','sol','aero','pixel','nebula','miso','sora','echo','boreal','octopus','waffle','tiger','meteor'];

/* ---------- Endpoints ---------- */
const PRIMARY_DICEBEAR = 'https://api.dicebear.com/9.x';
const FALLBACK_DICEBEAR = 'https://avatars.dicebear.com/api';

/* ---------- Background defs ---------- */
function buildDefsAndRect(bgType, color, size){
  const idPrefix = 'mb_' + Math.random().toString(36).slice(2,8);
  let defs = '';
  let rectFill = color || 'transparent';
  let noiseFilterId = null;

  if(bgType === 'transparent'){ rectFill = 'none'; }
  else if(bgType === 'solid'){ rectFill = color; }
  else if(bgType === 'gradient'){
    const gradId = idPrefix + '_g';
    const lighter = mixWithWhite(color,0.55);
    defs = `<linearGradient id="${gradId}" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="${color}" /><stop offset="100%" stop-color="${lighter}" stop-opacity="0.9" /></linearGradient>`;
    rectFill = `url(#${gradId})`;
  }
  else if(bgType === 'radial'){
    const rid = idPrefix + '_r';
    const lighter = mixWithWhite(color,0.6);
    defs = `<radialGradient id="${rid}" cx="30%" cy="30%" r="80%"><stop offset="0%" stop-color="${lighter}" /><stop offset="100%" stop-color="${color}" /></radialGradient>`;
    rectFill = `url(#${rid})`;
  }
  else if(bgType === 'dots'){
    const patId = idPrefix + '_p';
    defs = `<pattern id="${patId}" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="${mixWithWhite(color,0.85)}"/><circle cx="6" cy="6" r="2" fill="${color}"/></pattern>`;
    rectFill = `url(#${patId})`;
  }
  else if(bgType === 'stripes'){
    const patId = idPrefix + '_s';
    defs = `<pattern id="${patId}" width="10" height="10" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><rect width="5" height="10" fill="${color}" /><rect x="5" width="5" height="10" fill="transparent" /></pattern>`;
    rectFill = `url(#${patId})`;
  }
  else if(bgType === 'checker'){
    const patId = idPrefix + '_c';
    const lighter = mixWithWhite(color,0.7);
    defs = `<pattern id="${patId}" width="20" height="20" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="${color}"/><rect x="10" y="10" width="10" height="10" fill="${color}"/><rect width="10" height="10" fill="${lighter}"/><rect x="10" y="10" width="10" height="10" fill="${lighter}"/></pattern>`;
    rectFill = `url(#${patId})`;
  }
  else if(bgType === 'noise'){
    const filterId = idPrefix + '_f';
    defs = `<filter id="${filterId}"><feTurbulence baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0.2"/><feBlend mode="overlay" in2="SourceGraphic"/></filter>`;
    rectFill = color;
    noiseFilterId = filterId;
  }

  return { defs, rectFill, noiseFilterId };
}

/* ---------- Helper: extract inner dimensions and content ---------- */
function extractInnerSvgInfo(svgText, defaultSize){
  if(!svgText) return { innerSvg:'', w: defaultSize, h: defaultSize };
  svgText = svgText.replace(/^<\?xml[\s\S]*?\?>\s*/i, '');
  const vb = svgText.match(/viewBox=["']?([\d\.\-\s,]+)["']?/i);
  if(vb){
    const parts = vb[1].trim().split(/[\s,]+/).map(Number);
    if(parts.length >= 4 && parts[2] && parts[3]){
      const innerW = Math.abs(parts[2]);
      const innerH = Math.abs(parts[3]);
      const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,'');
      return { innerSvg: inner, w: innerW, h: innerH };
    }
  }
  const wAttr = svgText.match(/<svg[^>]*\bwidth=["']?(\d+(?:\.\d+)?)["']?/i);
  const hAttr = svgText.match(/<svg[^>]*\bheight=["']?(\d+(?:\.\d+)?)["']?/i);
  if(wAttr || hAttr){
    const innerW = wAttr ? Math.round(Number(wAttr[1])) : defaultSize;
    const innerH = hAttr ? Math.round(Number(hAttr[1])) : defaultSize;
    const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,'');
    return { innerSvg: inner, w: innerW, h: innerH };
  }
  const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,'');
  return { innerSvg: inner, w: defaultSize, h: defaultSize };
}

/* ---------- Build final SVG (centered & scaled to fill) ---------- */
async function buildFinalSvg(settings){
  const outSize = clamp(parseInt(settings.size)||512, 64, 4096);
  const scalePercent = clamp(parseFloat(settings.scale)||100, 50, 200);
  const userScale = scalePercent / 100;
  const rotation = clamp(parseFloat(settings.rotation)||0, -360, 360);
  const bgType = settings.bgType;
  const bgColor = settings.bgColor || '#ffffff';
  const style = settings.style;
  const seed = (settings.seed || 'anon').toString();

  const { defs, rectFill, noiseFilterId } = buildDefsAndRect(bgType, bgColor, outSize);

  let innerSvg = '';
  let innerW = outSize;
  let innerH = outSize;

  if(style === 'jdenticon'){
    const svgText = jdenticon.toSvg(seed, outSize);
    const info = extractInnerSvgInfo(svgText, outSize);
    innerSvg = info.innerSvg;
    innerW = info.w;
    innerH = info.h;
  } else {
    const tryUrls = [
      `${PRIMARY_DICEBEAR}/${style}/svg?seed=${encodeURIComponent(seed)}&size=${outSize}`,
      `${FALLBACK_DICEBEAR}/${style}/${encodeURIComponent(seed)}.svg?size=${outSize}`
    ];
    let lastErr = null;
    let fetchedText = null;
    for(const url of tryUrls){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok){ lastErr = new Error('Fetch failed ' + res.status + ' from ' + url); continue; }
        fetchedText = await res.text();
        break;
      } catch(e){ lastErr = e; }
    }
    if(!fetchedText){
      throw new Error('Failed to fetch SVG from remote endpoints. See console for details. ' + (lastErr && lastErr.message));
    }
    const info = extractInnerSvgInfo(fetchedText, outSize);
    innerSvg = info.innerSvg;
    innerW = info.w;
    innerH = info.h;
  }

  const maxInner = Math.max(innerW, innerH) || outSize;
  const fillScale = (outSize / maxInner);
  const totalScale = fillScale * userScale;

  const cx = outSize/2, cy = outSize/2;
  // Scale about center, but inner coordinate origin might not be 0,0 so later we translate by innerW/2,innerH/2
  const transform = `translate(${cx},${cy}) rotate(${rotation}) scale(${totalScale}) translate(${-innerW/2},${-innerH/2})`;
  const rectFilterAttr = noiseFilterId ? ` filter="url(#${noiseFilterId})"` : '';

  const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${outSize}" height="${outSize}" viewBox="0 0 ${outSize} ${outSize}" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Monadicon">
  <defs>
    ${defs}
  </defs>
  <rect width="${outSize}" height="${outSize}" fill="${rectFill}" ${rectFilterAttr} />
  <g transform="${transform}">
    ${innerSvg}
  </g>
</svg>`;
  return svg;
}

/* ---------- Render preview ---------- */
async function renderPreview(settings, { addToHistory=false } = {}){
  previewBox.innerHTML = `<div style="color:var(--muted);text-align:center">Rendering...</div>`;
  try{
    const finalSvg = await buildFinalSvg(settings);
    previewBox.innerHTML = finalSvg;
    if(placeholder) placeholder.style.display = 'none';
    previewMeta.textContent = `${settings.style} • ${settings.seed} • ${settings.size}px`;
    settingsOut.textContent = JSON.stringify(settings, null, 2);

    if(addToHistory){
      history.unshift({settings, svg: finalSvg});
      if(history.length>28) history.pop();
      renderHistory();
      confetti();
    }
  }catch(e){
    previewBox.innerHTML = `<div style="color:#ff6b6b;font-weight:700">Error rendering preview</div><div style="color:var(--muted);margin-top:8px">Check console for details.</div>`;
    console.error('Preview error:', e);
  }
}

/* ---------- Download helpers ---------- */
function downloadSVGfromString(svgString, filename='monadicon.svg'){
  const blob = new Blob([svgString], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function downloadPNGfromSvgString(svgString, filename='monadicon.png'){
  const img = new Image();
  img.onload = () => {
    const w = img.width, h = img.height;
    const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0);
    canvas.toBlob((blob)=>{ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }, 'image/png');
  };
  img.onerror = e => { alert('PNG conversion failed; see console.'); console.error(e); };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
}

/* ---------- History UI ---------- */
function renderHistory(){
  historyEl.innerHTML = '';
  for(const item of history){
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.title = `${item.settings.seed} • ${item.settings.style}`;
    const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(item.svg)));
    thumb.appendChild(img);
    thumb.onclick = ()=> { loadSettings(item.settings); renderPreview(item.settings); };
    historyEl.appendChild(thumb);
  }
}

/* ---------- Copy/Export ---------- */
function copyToClipboard(text){ navigator.clipboard.writeText(text).catch(e=>{ console.error('copy failed', e); alert('Copy failed'); }); }

/* ---------- Wiring & events ---------- */
function readSettingsFromUI(){
  return {
    seed: seedEl.value || 'anon',
    style: styleEl.value,
    size: parseInt(sizeEl.value) || 512,
    scale: parseFloat(scaleEl.value) || 100,
    rotation: parseFloat(rotationEl.value) || 0,
    bgType: bgTypeEl.value,
    bgColor: bgColorEl.value || '#7C3AED'
  };
}
function loadSettings(s){
  seedEl.value = s.seed || 'anon';
  styleEl.value = s.style || 'adventurer';
  sizeEl.value = s.size || 512;
  scaleEl.value = s.scale || 100;
  rotationEl.value = s.rotation || 0;
  bgTypeEl.value = s.bgType || 'transparent';
  bgColorEl.value = s.bgColor || '#7C3AED';
  settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2);
}

/* Generate / preview handlers */
generateBtn.addEventListener('click', async ()=>{
  const s = readSettingsFromUI();
  await renderPreview(s, { addToHistory:true });
});
applyPreviewBtn.addEventListener('click', async ()=>{
  const s = readSettingsFromUI();
  await renderPreview(s, { addToHistory:false });
});

/* Downloads & shares */
downloadSvgBtn.addEventListener('click', async ()=>{
  const s = readSettingsFromUI();
  const svg = await buildFinalSvg(s);
  downloadSVGfromString(svg, `${(s.seed||'monadicon')}.svg`);
});
downloadPngBtn.addEventListener('click', async ()=>{
  const s = readSettingsFromUI();
  const svg = await buildFinalSvg(s);
  downloadPNGfromSvgString(svg, `${(s.seed||'monadicon')}.png`);
});
copyEmbedBtn.addEventListener('click', async ()=>{
  const s = readSettingsFromUI();
  const svg = await buildFinalSvg(s);
  copyToClipboard(svg);
  alert('SVG embed copied to clipboard (full SVG markup)');
});
qs('#shareX').addEventListener('click', ()=>{
  const s = readSettingsFromUI();
  const params = new URLSearchParams(s);
  const url = location.origin + location.pathname + '?' + params.toString();
  const tweet = `I made a Monadicon — ${url}`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweet)}`, '_blank');
});
qs('#shareDiscord').addEventListener('click', ()=>{
  const s = readSettingsFromUI();
  const params = new URLSearchParams(s);
  const url = location.origin + location.pathname + '?' + params.toString();
  copyToClipboard(url); alert('Share link copied to clipboard — paste into Discord');
});

/* Random / presets */
randomBtn.addEventListener('click', ()=>{
  seedEl.value = sampleSeeds[Math.floor(Math.random()*sampleSeeds.length)] + '-' + Math.floor(Math.random()*9999);
  const styles = qsa('#style option').map(o=>o.value);
  styleEl.value = styles[Math.floor(Math.random()*styles.length)];
  bgTypeEl.value = ['transparent','solid','gradient','radial','dots','stripes','checker','noise'][Math.floor(Math.random()*8)];
  bgColorEl.value = '#'+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0');
  sizeEl.value = [128,256,512,768,1024][Math.floor(Math.random()*5)];
  scaleEl.value = 80 + Math.floor(Math.random()*60);
  rotationEl.value = Math.floor(Math.random()*360)-180;
  if(liveToggle.checked) applyPreviewBtn.click();
});
qs('#randomPreset').addEventListener('click', ()=> randomBtn.click());
qsa('.preset').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const seed = btn.dataset.seed;
    const style = btn.dataset.style;
    if(seed) seedEl.value = seed;
    if(style) styleEl.value = style;
    if(liveToggle.checked) applyPreviewBtn.click();
  });
});

/* Live preview */
function setupLivePreview(){
  const inputs = [seedEl, styleEl, sizeEl, scaleEl, rotationEl, bgTypeEl, bgColorEl];
  inputs.forEach(inp => {
    inp.addEventListener('input', () => {
      settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2);
      if(liveToggle.checked){
        if(window._liveTimeout) clearTimeout(window._liveTimeout);
        window._liveTimeout = setTimeout(()=>{ applyPreviewBtn.click(); }, 300);
      }
    });
  });
}
setupLivePreview();

/* URL params */
function applyUrlParams(){
  const params = new URLSearchParams(window.location.search);
  if([...params.keys()].length === 0) return;
  const s = {};
  for(const key of ['seed','style','size','scale','rotation','bgType','bgColor']){
    if(params.get(key)!==null) s[key] = params.get(key);
  }
  if(Object.keys(s).length) { loadSettings(s); applyPreviewBtn.click(); }
}
applyUrlParams();

/* Export settings button: download JSON + copy to clipboard + notify */
if(exportJSON){
  exportJSON.addEventListener('click', ()=>{
    try {
      const settings = readSettingsFromUI();
      const jsonText = JSON.stringify(settings, null, 2);
      // Download
      const filename = `monadicon-settings-${Date.now()}.json`;
      const blob = new Blob([jsonText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Copy to clipboard (best-effort)
      navigator.clipboard?.writeText(jsonText).catch(()=>{/* ignore copy errors */});

      // Notify user
      alert(`Settings exported as ${filename} and copied to clipboard.`);
    } catch (err) {
      console.error('Export failed', err);
      alert('Export failed — see console for details.');
    }
  });
}

/* Export other UI handlers */
qs('#copyJSON').addEventListener('click', ()=>{ copyToClipboard(JSON.stringify(readSettingsFromUI(), null, 2)); alert('Settings JSON copied'); });
qs('#downloadJSON').addEventListener('click', ()=>{ const txt = JSON.stringify(readSettingsFromUI(), null, 2); const blob = new Blob([txt], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='monadicon-settings.json'; a.click(); });

/* History clear */
qs('#clearHistory').addEventListener('click', ()=>{ history=[]; renderHistory(); });

/* Theme toggle + persistence */
function setTheme(light){
  isLight = !!light;
  if(isLight){ document.body.classList.add('light'); document.body.classList.remove('dark'); toggleThemeBtn.textContent = 'Dark'; }
  else { document.body.classList.remove('light'); document.body.classList.add('dark'); toggleThemeBtn.textContent = 'Light'; }
  try{ localStorage.setItem('monadicons:theme', isLight ? 'light' : 'dark'); }catch(e){}
}
toggleThemeBtn.addEventListener('click', ()=> setTheme(!isLight));
try{ const p = localStorage.getItem('monadicons:theme'); setTheme(p === 'light'); }catch(e){ setTheme(false); }

/* Confetti & particles (unchanged) */
function confetti(){ const canvas=document.createElement('canvas'); canvas.style.position='fixed'; canvas.style.left='0'; canvas.style.top='0'; canvas.style.pointerEvents='none'; canvas.width=innerWidth; canvas.height=innerHeight; document.body.appendChild(canvas); const ctx=canvas.getContext('2d'); const pieces=Array.from({length:80}, ()=>({x:innerWidth/2+(Math.random()-0.5)*200,y:innerHeight/2+(Math.random()-0.5)*60,vx:(Math.random()-0.5)*8,vy:Math.random()*-10-2,r:Math.random()*6+3,c:`hsl(${Math.random()*360},80%,60%)`,rot:Math.random()*Math.PI})); (function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.4; p.rot+=0.2; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); if(p.y>canvas.height+50) pieces.splice(i,1); }); if(pieces.length) requestAnimationFrame(anim); else canvas.remove(); })(); }
(function initParticles(){ const can=document.createElement('canvas'); can.id='particles-canvas'; can.style.position='fixed'; can.style.top='0'; can.style.left='0'; can.style.width='100%'; can.style.height='100%'; can.style.pointerEvents='none'; can.style.zIndex='-1'; document.body.appendChild(can); const ctx = can.getContext('2d'); function resize(){ can.width = innerWidth; can.height = innerHeight; } window.addEventListener('resize', resize); resize(); const parts = Array.from({length:90}, ()=>({x:Math.random()*can.width,y:Math.random()*can.height,r:Math.random()*1.8+0.6,vx:(Math.random()-.5)*0.4,vy:(Math.random()-.5)*0.4})); (function draw(){ ctx.clearRect(0,0,can.width,can.height); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>can.width)p.vx*=-1; if(p.y<0||p.y>can.height)p.vy*=-1; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='rgba(124,58,237,0.06)'; ctx.fill(); }); requestAnimationFrame(draw); })(); })();

/* init */
settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2);
applyPreviewBtn.click();

</script>
</body>
</html>
