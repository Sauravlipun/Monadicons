<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monadicons — Avatar Studio</title>
  <meta name="description" content="Monadicons — generate avatars, names and metadata" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%237C3AED'/><text x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'>M</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/jdenticon@3.2.0/dist/jdenticon.min.js"></script>

  <style>
    /* ====== FUNKY THEME + LAYOUT ====== */
    :root{
      --accent:#7C3AED; --accent-2:#FF6B6B; --accent-3:#FFD166; --muted:rgba(230,238,248,0.8);
      --bg-1:#05020a; --bg-2:#081028; --card-bg:rgba(255,255,255,0.03); --glass:rgba(255,255,255,0.03);
      --gap:18px; --radius:14px; --glass-2: rgba(255,255,255,0.02);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--muted);
      background: radial-gradient(800px 400px at 10% 10%, rgba(124,58,237,0.08), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      overflow-y:auto; -webkit-font-smoothing:antialiased; padding:28px;}

    /* animated soft gradient behind everything */
    .bg-anim{position:fixed;inset:0;z-index:-2;pointer-events:none;}
    .bg-anim::before, .bg-anim::after{content:'';position:absolute;filter:blur(64px);opacity:0.55;mix-blend-mode:screen}
    .bg-anim::before{left:-10%;top:-20%;width:50vw;height:60vh;background:linear-gradient(45deg,var(--accent),var(--accent-3));animation:float1 12s ease-in-out infinite}
    .bg-anim::after{right:-5%;bottom:-10%;width:40vw;height:50vh;background:linear-gradient(135deg,var(--accent-2),#6EE7B7);animation:float2 14s ease-in-out infinite}
    @keyframes float1{0%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-30px) rotate(8deg)}100%{transform:translateY(0) rotate(0deg)}}
    @keyframes float2{0%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(30px) rotate(-6deg)}100%{transform:translateY(0) rotate(0deg)}}

    .container{max-width:1240px;margin:0 auto;display:flex;flex-direction:column;gap:18px}

    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:white;font-size:22px;box-shadow:0 10px 30px rgba(124,58,237,0.12);transform:translateZ(0);}
    .logo:hover{transform:rotate(-6deg) scale(1.03)}
    h1{font-size:20px;margin:0}

    .header-actions{display:flex;gap:10px;align-items:center}

    .btn,.ghost,.small{cursor:pointer;border-radius:12px;padding:8px 12px;font-weight:700;border:none;outline:none;transition:all .18s cubic-bezier(.2,.9,.28,1)}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 32px rgba(124,58,237,0.18);}
    .btn:hover{transform:translateY(-4px);box-shadow:0 18px 48px rgba(124,58,237,0.22)}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}
    .ghost:hover{background:rgba(255,255,255,0.02);transform:translateY(-2px)}
    .small{background:var(--glass);color:var(--muted);padding:6px 10px}

    .grid{display:grid;grid-template-columns:1fr 460px;gap:22px;align-items:start}
    @media (max-width:1024px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(6px)}
    .controls label{display:block;font-size:13px;color:rgba(230,238,248,0.7);margin:8px 0 6px}
    .row{display:flex;gap:8px;align-items:center}
    .input,select,textarea,input[type='color'],input[type='number'],input[type='text']{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}

    /* Preview box with glass + inner neon rim */
    .preview-box{width:100%;height:480px;border-radius:18px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;box-shadow:inset 0 2px 24px rgba(0,0,0,0.45)}
    .preview-box:hover{transform:translateY(-6px);transition:transform .28s cubic-bezier(.2,.9,.28,1)}
    .preview-box>img,.preview-box>svg{width:100%;height:100%;object-fit:cover;display:block}

    .preview-meta{color:rgba(230,238,248,0.75);font-size:13px;margin-top:10px;text-align:center}

    .history{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:72px;height:72px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;cursor:pointer;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.92));display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.45)}
    .thumb img{width:100%;height:100%;object-fit:cover}

    .desc-card{margin-top:12px;padding:12px;border-radius:12px}
    .desc-title{font-weight:800;margin-bottom:6px}
    .desc-text{background:transparent;border-radius:8px;padding:10px;border:1px dashed rgba(255,255,255,0.04);color:var(--muted);font-size:14px;white-space:pre-wrap}

    #toast{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:linear-gradient(90deg, rgba(0,0,0,0.7), rgba(24,24,24,0.85));color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.6);font-weight:700}

    /* Name generator funky styles */
    .name-generator{margin-top:14px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(124,58,237,0.03), rgba(255,107,107,0.02));border:1px solid rgba(255,255,255,0.03)}
    .swatches{display:flex;gap:8px;margin-top:8px}
    .swatch{width:30px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.35)}

    #badgeOverlay{position:absolute;top:14px;right:14px;background:linear-gradient(90deg,#ffd166,#ff8a66);color:#111;padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px;box-shadow:0 12px 36px rgba(0,0,0,0.45);display:none;z-index:40}
    .badge-animate{animation:badgePop .72s cubic-bezier(.2,.9,.28,1)}
    @keyframes badgePop{0%{transform:scale(.4) rotate(-10deg);opacity:0}55%{transform:scale(1.12) rotate(6deg);opacity:1}100%{transform:scale(1) rotate(0deg);opacity:1}}
    .badge-epic{box-shadow:0 12px 44px rgba(130,90,255,0.18),0 0 38px rgba(255,220,120,0.06) inset}
    .badge-legendary{box-shadow:0 18px 64px rgba(255,80,80,0.22),0 0 80px rgba(255,180,80,0.08) inset}

    /* responsive tweaks */
    @media (max-width:720px){ .logo{width:46px;height:46px;font-size:18px} .preview-box{height:380px} }
  </style>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo" id="logo">M</div>
        <div>
          <h1>Monadicons</h1>
          <div style="font-size:12px;color:rgba(230,238,248,0.6)">Funky avatar + name studio</div>
        </div>
      </div>

      <div class="header-actions">
        <div class="switch" title="Live preview (updates as you change inputs)">
          <input id="liveToggle" type="checkbox" checked>
          <label for="liveToggle" style="color:var(--muted);font-weight:700">Live</label>
        </div>
        <button id="randomBtn" class="ghost">Random</button>
        <button id="exportJSON" class="small">Export</button>
        <button id="toggleTheme" class="small">Light</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card controls">
        <label for="seed">Seed / Name</label>
        <input id="seed" class="input" type="text" placeholder="e.g., aurora" value="anon" />

        <label for="prompt">Prompt</label>
        <textarea id="prompt" rows="3" class="input" placeholder="Enter a prompt (e.g., 'friendly blue fox with stars')"></textarea>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <button id="applyPrompt" class="ghost">Apply Prompt → Seed</button>
          <button id="generateFromPrompt" class="btn">Generate from Prompt</button>
          <button id="generateName" class="ghost">Generate Name</button>
          <div style="flex:1"></div>
          <label style="font-size:13px;color:var(--muted)"><input id="promptUseAsSeed" type="checkbox" style="margin-right:6px">Use prompt as seed automatically</label>
        </div>

        <div style="margin-top:12px;border-radius:10px;padding:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)">
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
            <div style="font-weight:800">Multi-seed</div>
            <label style="font-size:13px;color:var(--muted)"><input id="multiSeed" type="checkbox" style="margin-right:6px">Enable</label>
          </div>

          <div style="display:grid;grid-template-columns:1fr 120px 150px;gap:8px;margin-top:10px">
            <div>
              <label for="delimiter">Delimiter</label>
              <select id="delimiter" class="input">
                <option value="space">Space</option>
                <option value="comma">Comma</option>
                <option value="newline">Newline</option>
                <option value="char">Each char</option>
              </select>
            </div>

            <div>
              <label for="partsCount">Parts</label>
              <input id="partsCount" class="input" type="number" min="2" max="12" value="3" />
            </div>

            <div>
              <label for="composeMode">Compose</label>
              <select id="composeMode" class="input">
                <option value="grid">Grid</option>
                <option value="layer">Layered</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="font-size:13px;color:var(--muted);display:flex;align-items:center">
              <input id="randomizeParts" type="checkbox" style="margin-right:6px">Randomize parts • deterministic
            </label>
            <div style="flex:1"></div>
            <small style="color:var(--muted)">Creates multiple seeds from the prompt and combines them.</small>
          </div>
        </div>

        <label for="style" style="margin-top:10px">Style</label>
        <select id="style" class="input">
          <optgroup label="Avatar styles">
            <option value="adventurer">adventurer</option>
            <option value="avataaars">avataaars</option>
            <option value="big-ears">big-ears</option>
            <option value="bottts">bottts</option>
            <option value="micah">micah</option>
            <option value="pixel-art-neutral">pixel-art-neutral</option>
            <option value="identicon">identicon</option>
          </optgroup>
          <optgroup label="Local">
            <option value="jdenticon">jdenticon (local)</option>
          </optgroup>
        </select>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1">
            <label for="size">Size (px)</label>
            <input id="size" class="input" type="number" min="64" max="4096" value="512" />
          </div>
          <div style="width:150px">
            <label for="scale">Scale (%)</label>
            <input id="scale" class="input" type="number" min="50" max="200" value="100" />
          </div>
          <div style="width:150px">
            <label for="rotation">Rotation (°)</label>
            <input id="rotation" class="input" type="number" min="-180" max="180" value="0" />
          </div>
        </div>

        <label for="bgType">Background type</label>
        <select id="bgType" class="input">
          <option value="transparent">transparent</option>
          <option value="solid">solid</option>
          <option value="gradient">gradient</option>
          <option value="radial">radial</option>
          <option value="dots">dots</option>
          <option value="stripes">stripes</option>
          <option value="checker">checker</option>
          <option value="noise">noise</option>
        </select>

        <label for="bgColor">Background color</label>
        <input id="bgColor" type="color" value="#7C3AED" class="input" />

        <div style="display:flex;gap:8px;margin-top:14px;align-items:center">
          <button id="generateBtn" class="btn">Generate (Add to history)</button>
          <button id="applyPreviewBtn" class="ghost">Apply Preview</button>
          <div style="flex:1"></div>
          <button id="clearHistory" class="small">Clear</button>
        </div>

        <div class="toolbar" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="downloadSvg" class="ghost">Download SVG</button>
          <button id="downloadPng" class="ghost">Download PNG</button>
          <button id="copyEmbed" class="ghost">Copy Embed</button>
          <button id="shareX" class="ghost">Share X</button>
          <button id="shareDiscord" class="ghost">Share Discord</button>
        </div>

        <div style="margin-top:12px">
          <label>Presets</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="small preset" data-seed="aurora" data-style="adventurer">Aurora</button>
            <button class="small preset" data-seed="nebula" data-style="pixel-art-neutral">Nebula</button>
            <button class="small preset" data-seed="octopus" data-style="micah">Octopus</button>
            <button class="small preset" data-seed="miso" data-style="jdenticon">Miso</button>
            <button class="small" id="randomPreset">Surprise me</button>
          </div>
        </div>

        <!-- Name generator -->
        <div class="name-generator">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Name Generator</div>
            <div style="font-size:13px;color:var(--muted)">Make it collectible ✨</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input id="generatedName" class="input" placeholder="Click Generate Name" />
            <button id="genNameBtn" class="btn small">Generate</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="copyNameBtn" class="ghost small">Copy</button>
            <button id="applyNameAsSeed" class="ghost small">Apply as Seed</button>
            <label style="margin-left:auto;color:var(--muted);font-size:13px;display:flex;align-items:center">
              <input id="deterministicName" type="checkbox" style="margin-right:6px">Deterministic
            </label>
          </div>

          <div class="swatches" id="palette" title="Click to copy color"></div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="display:flex;align-items:center;gap:8px;">
              <input id="badgeToggle" type="checkbox"> <span style="color:var(--muted)">Show badge</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin-left:12px;">
              <input id="autoNameOnGenerate" type="checkbox" checked> <span style="color:var(--muted)">Auto-name on generate</span>
            </label>
            <div style="flex:1"></div>
            <small style="color:var(--muted)">Badge shows rarity</small>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>History</label>
          <div class="history" id="history"></div>
        </div>

        <div style="margin-top:12px">
          <label>Export/Save</label>
          <div class="row" style="gap:8px;margin-top:8px">
            <button id="copyJSON" class="small">Copy JSON</button>
            <button id="downloadJSON" class="small">Download JSON</button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <div class="preview-box" id="previewBox">
            <div id="placeholder" style="text-align:center;color:var(--muted)">
              <div style="font-size:18px;margin-bottom:6px">Preview</div>
              <div style="font-size:13px">Configure settings on the left, then click Generate (or toggle Live)</div>
            </div>
            <div id="badgeOverlay" aria-hidden="true"></div>
          </div>
          <div class="preview-meta" id="previewMeta">—</div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Options snapshot</div>
            <div style="color:var(--muted);font-size:13px">Copy / Share below</div>
          </div>
          <pre id="settingsOut" style="white-space:pre-wrap;word-break:break-word;background:transparent;border:none;color:var(--muted);margin-top:8px"></pre>

          <div class="desc-card" id="descCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="desc-title">Auto Description</div>
                <div style="color:var(--muted);font-size:13px">A short NFT-style description and attributes.</div>
              </div>
              <div style="display:flex;gap:8px">
                <button id="regenDesc" class="small">Regenerate</button>
                <button id="copyDesc" class="small">Copy</button>
                <button id="downloadMeta" class="small">Download JSON</button>
              </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:10px;align-items:flex-start">
              <div style="width:96px;height:96px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center" id="descThumb"></div>
              <div style="flex:1">
                <div id="autoDesc" class="desc-text">Generate an icon to view the auto-description here.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="text-align:center;color:var(--muted);margin-top:8px">Powered by Monadicons • ©2025</div>
  </div>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
    // All functionality preserved from the working version; small UI flair additions below.

    // DOM refs
    const liveToggle = document.getElementById('liveToggle');
    const seedEl = document.getElementById('seed');
    const promptEl = document.getElementById('prompt');
    const promptUseAsSeedEl = document.getElementById('promptUseAsSeed');
    const applyPromptBtn = document.getElementById('applyPrompt');
    const generateFromPromptBtn = document.getElementById('generateFromPrompt');
    const generateNameBtn = document.getElementById('generateName');
    const styleEl = document.getElementById('style');
    const sizeEl = document.getElementById('size');
    const scaleEl = document.getElementById('scale');
    const rotationEl = document.getElementById('rotation');
    const bgTypeEl = document.getElementById('bgType');
    const bgColorEl = document.getElementById('bgColor');
    const generateBtn = document.getElementById('generateBtn');
    const applyPreviewBtn = document.getElementById('applyPreviewBtn');
    const randomBtn = document.getElementById('randomBtn');
    const previewBox = document.getElementById('previewBox');
    const previewMeta = document.getElementById('previewMeta');
    const placeholder = document.getElementById('placeholder');
    const downloadSvgBtn = document.getElementById('downloadSvg');
    const downloadPngBtn = document.getElementById('downloadPng');
    const copyEmbedBtn = document.getElementById('copyEmbed');
    const historyEl = document.getElementById('history');
    const copyJSON = document.getElementById('copyJSON');
    const downloadJSON = document.getElementById('downloadJSON');
    const exportJSON = document.getElementById('exportJSON');
    const settingsOut = document.getElementById('settingsOut');
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const autoDescEl = document.getElementById('autoDesc');
    const descThumb = document.getElementById('descThumb');
    const regenDescBtn = document.getElementById('regenDesc');
    const copyDescBtn = document.getElementById('copyDesc');
    const downloadMetaBtn = document.getElementById('downloadMeta');
    const randomPreset = document.getElementById('randomPreset');
    const clearHistory = document.getElementById('clearHistory');

    // Name UI
    const generatedNameEl = document.getElementById('generatedName');
    const genNameBtn = document.getElementById('genNameBtn');
    const copyNameBtn = document.getElementById('copyNameBtn');
    const applyNameAsSeedBtn = document.getElementById('applyNameAsSeed');
    const deterministicNameCheckbox = document.getElementById('deterministicName');
    const paletteEl = document.getElementById('palette');
    const badgeToggle = document.getElementById('badgeToggle');
    const badgeOverlay = document.getElementById('badgeOverlay');
    const autoNameOnGenerateCheckbox = document.getElementById('autoNameOnGenerate');

    const shareXBtn = document.getElementById('shareX');
    const shareDiscordBtn = document.getElementById('shareDiscord');

    // mini-glossary & helpers
    const sampleSeeds = ['aurora','lumen','nova','zephyr','sol','aero','pixel','nebula','miso','sora','echo','boreal','octopus','waffle','tiger','meteor'];
    let history = [];

    function showToast(msg, ms = 2200) {
      const container = document.getElementById('toast');
      const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; container.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; setTimeout(()=>t.remove(),250); }, ms);
    }

    function hashString(s){ let h=2166136261; for(let i=0;i<s.length;i++){ h=Math.imul(h ^ s.charCodeAt(i),16777619); } return h; }
    function slugifyPrompt(s){ const trimmed=(s||'').trim(); const slug=trimmed.toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-').slice(0,70)||'anon'; const h=Math.abs(hashString(trimmed||slug)).toString(16).slice(0,5); return `${slug}-${h}`; }
    function seededRandomFromSeed(seed){ let h=hashString(seed); return function(){ h ^= h<<13; h ^= h>>>17; h ^= h<<5; return (h>>>0)/4294967296; }; }
    function pickDeterministic(arr, seed, idx=0){ if(!arr||!arr.length) return null; const rnd = seededRandomFromSeed(seed + '|' + idx); return arr[Math.floor(rnd()*arr.length)]; }
    function clamp(value,min,max){ return Math.max(min, Math.min(max, value)); }
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function shortHex(seed){ return (hashString(seed)>>>0).toString(16).slice(0,4).toUpperCase(); }

    // color helpers
    function hexToRgb(hex){ hex=(hex||'#ffffff').replace('#',''); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); return { r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16) }; }
    function mixWithWhite(hex,pct=0.6){ const c=hexToRgb(hex); const r=Math.round(c.r + (255-c.r)*pct); const g=Math.round(c.g + (255-c.g)*pct); const b=Math.round(c.b + (255-c.b)*pct); return `rgb(${r}, ${g}, ${b})`; }
    function hslToHex(h,s,l){ s/=100; l/=100; const k = n => (n + h/30) % 12; const a = s * Math.min(l,1-l); const f = n => Math.round(255 * (l - a * Math.max(Math.min(k(n)-3,9-k(n),1), -1))); return `#${((1<<24) + (f(0)<<16) + (f(8)<<8) + f(4)).toString(16).slice(1)}`; }

    function generatePaletteFromSeed(seed, count=3){ const rnd = seededRandomFromSeed(seed + '|palette'); const colors=[]; for(let i=0;i<count;i++){ const h=Math.floor(rnd()*360); const s=60 + Math.floor(rnd()*30); const l=45 + Math.floor(rnd()*10); colors.push(hslToHex(h,s,l)); } return colors; }
    function renderPalette(colors){ paletteEl.innerHTML=''; colors.forEach(color=>{ const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=color; sw.title=color; sw.onclick=async ()=>{ try{ await navigator.clipboard.writeText(color); showToast(`Copied ${color}`); }catch{ showToast('Copy failed'); } }; paletteEl.appendChild(sw); }); }

    // name generator
    function generateRandomName(deterministic=false){ const adjectives = ['Glowing','Playful','Enigmatic','Vibrant','Serene','Bold','Whimsical','Sleek','Crisp','Dreamy','Electric','Retro','Nova','Lunar','Solar','Aether','Frost','Ember','Velvet','Obsidian']; const nouns = ['Fox','Monolith','Echo','Warden','Sprite','Aurora','Comet','Cipher','Bard','Golem','Lattice','Oracle','Nimbus','Voyager','Pulse','Glyph','Prism','Nebula','Beacon','Harbor']; let seedSource = (seedEl.value || '').toString().trim(); if(!seedSource) seedSource = (promptEl.value || '').toString().trim() || ('rand'+Math.floor(Math.random()*9999)); let adj,noun; if(deterministic){ adj = pickDeterministic(adjectives, seedSource, 0) || pickRandom(adjectives); noun = pickDeterministic(nouns, seedSource, 1) || pickRandom(nouns); } else { adj = pickRandom(adjectives); noun = pickRandom(nouns); } return `${adj} ${noun} #${shortHex(seedSource)}`; }

    function computeRarity(seedString){ const h = hashString(seedString).toString(); const v = parseInt(h.slice(-2),10) || 0; if(v>240) return 'Legendary'; if(v>200) return 'Epic'; if(v>140) return 'Rare'; if(v>80) return 'Uncommon'; return 'Common'; }

    function pickDeterministicAdjective(seed){ const adjectives=['glowing','playful','enigmatic','vibrant','serene','bold','whimsical','sleek','crisp','dreamy','electric','retro']; return pickDeterministic(adjectives, seed); }

    function generateAttributes(settings,seeds){ return [ { trait_type:'Style', value:settings.style }, { trait_type:'Background', value:settings.bgType }, { trait_type:'BgColor', value:settings.bgColor }, { trait_type:'Scale', value:`${settings.scale}%` }, { trait_type:'Rotation', value:`${settings.rotation}°` }, { trait_type:'Seeds', value: seeds.join(', ') }, { trait_type:'Rarity', value: computeRarity(seeds.join('|')) } ]; }

    function generateAutoDescription(settings,promptText,seeds){ const mainSeed = seeds && seeds.length ? seeds[0] : (settings.seed || 'anon'); const name = `${mainSeed.toString().slice(0,20)}`; const rarity = computeRarity(seeds.join('|') || mainSeed); const mood = pickDeterministicAdjective(seeds.join('|') + '|' + settings.style) || 'stylish'; const promptNote = promptText ? ` Inspired by "${promptText.trim().slice(0,120)}".` : ''; const blurb = `${name} is a ${mood} avatar rendered in the ${settings.style} style with a ${settings.bgType} background.${promptNote}`; const attributes = generateAttributes(settings,seeds); const traitsText = attributes.map(a=>`${a.trait_type}: ${a.value}`).join(' • '); const hashtags = ['#Monadicons','#Avatar','#SVG', `#${rarity}`].join(' '); const description = `${blurb}\n\nAttributes\n${traitsText}\n\nRarity: ${rarity}\n\n${hashtags}`; return { name, description, attributes, rarity }; }

    function updateAutoDescriptionFromRendered(svgText, settings){ try{ const seed = settings.seed ? settings.seed.toString() : 'anon'; const promptText = (promptEl.value || '').trim(); const meta = generateAutoDescription(settings, promptText, [seed]); autoDescEl.textContent = meta.description; const thumbData = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgText))); descThumb.innerHTML = `<img src="${thumbData}" alt="thumb" style="width:100%;height:100%;object-fit:cover" />`; regenDescBtn._meta = { meta, svg: svgText, settings }; copyDescBtn._meta = regenDescBtn._meta; downloadMetaBtn._meta = regenDescBtn._meta; }catch(e){ console.error('updateAutoDescriptionFromRendered error', e); } }

    // SVG building (Dicebear/jdenticon)
    function buildDefsAndRect(bgType,color,outSize){ const idPrefix='mb_'+Math.random().toString(36).slice(2,8); let defs='', rectFill=color||'transparent', noiseFilterId=null; if(bgType==='transparent') rectFill='none'; else if(bgType==='solid') rectFill=color; else if(bgType==='gradient'){ const gradId=idPrefix+'_g'; const lighter = mixWithWhite(color,0.55); defs = `<linearGradient id="${gradId}" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="${color}" /><stop offset="100%" stop-color="${lighter}" stop-opacity="0.9" /></linearGradient>`; rectFill=`url(#${gradId})`; } else if(bgType==='radial'){ const rid=idPrefix+'_r'; const lighter = mixWithWhite(color,0.6); defs = `<radialGradient id="${rid}" cx="30%" cy="30%" r="80%"><stop offset="0%" stop-color="${lighter}" /><stop offset="100%" stop-color="${color}" /></radialGradient>`; rectFill=`url(#${rid})`; } else if(bgType==='dots'){ const patId=idPrefix+'_p'; defs=`<pattern id="${patId}" width="12" height="12" patternUnits="userSpaceOnUse"><rect width="12" height="12" fill="${mixWithWhite(color,0.85)}"/><circle cx="6" cy="6" r="2" fill="${color}"/></pattern>`; rectFill=`url(#${patId})`; } else if(bgType==='stripes'){ const patId=idPrefix+'_s'; defs=`<pattern id="${patId}" width="10" height="10" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><rect width="5" height="10" fill="${color}" /><rect x="5" width="5" height="10" fill="transparent" /></pattern>`; rectFill=`url(#${patId})`; } else if(bgType==='checker'){ const patId=idPrefix+'_c'; const lighter = mixWithWhite(color,0.7); defs=`<pattern id="${patId}" width="20" height="20" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="${color}"/><rect x="10" y="10" width="10" height="10" fill="${color}"/><rect width="10" height="10" fill="${lighter}"/><rect x="10" y="10" width="10" height="10" fill="${lighter}"/></pattern>`; rectFill=`url(#${patId})`; } else if(bgType==='noise'){ const filterId=idPrefix+'_f'; defs=`<filter id="${filterId}"><feTurbulence baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0.2"/><feBlend mode="overlay" in2="SourceGraphic"/></filter>`; rectFill=color; noiseFilterId=filterId; } return { defs, rectFill, noiseFilterId }; }

    function extractInnerSvgInfo(svgText, defaultSize){ if(!svgText) return { innerSvg:'', w:defaultSize, h:defaultSize }; svgText = svgText.replace(/^<\?xml[\s\S]*?\?>\s*/i,''); const vb = svgText.match(/viewBox=["']?([\d\.\-\s,]+)["']?/i); if(vb){ const parts = vb[1].trim().split(/[\s,]+/).map(Number); if(parts.length>=4 && parts[2] && parts[3]){ const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,''); return { innerSvg: inner, w: Math.abs(parts[2]), h: Math.abs(parts[3]) }; } } const wAttr = svgText.match(/<svg[^>]*\bwidth=["']?(\d+(?:\.\d+)?)['"]?/i); const hAttr = svgText.match(/<svg[^>]*\bheight=["']?(\d+(?:\.\d+)?)['"]?/i); if(wAttr || hAttr){ const innerW = wAttr ? Math.round(Number(wAttr[1])) : defaultSize; const innerH = hAttr ? Math.round(Number(hAttr[1])) : defaultSize; const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,''); return { innerSvg: inner, w: innerW, h: innerH }; } const inner = svgText.replace(/^<svg[^>]*>/i,'').replace(/<\/svg>$/i,''); return { innerSvg: inner, w: defaultSize, h: defaultSize }; }

    async function buildFinalSvg(settings){ const outSize = clamp(parseInt(settings.size) || 512, 64, 4096); const userScale = clamp(parseFloat(settings.scale) || 100, 50, 200) / 100; const rotation = clamp(parseFloat(settings.rotation) || 0, -360, 360); const bgType = settings.bgType; const bgColor = settings.bgColor || '#ffffff'; const style = settings.style; const seed = (settings.seed || 'anon').toString(); const { defs, rectFill, noiseFilterId } = buildDefsAndRect(bgType, bgColor, outSize); let innerSvg=''; let innerW=outSize, innerH=outSize; if(style === 'jdenticon'){ const svgText = jdenticon.toSvg(seed, outSize); const info = extractInnerSvgInfo(svgText, outSize); innerSvg = info.innerSvg; innerW = info.w; innerH = info.h; } else { const tryUrls = [ `https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(seed)}&size=${outSize}`, `https://avatars.dicebear.com/api/${style}/${encodeURIComponent(seed)}.svg?size=${outSize}` ]; let fetchedText = null; for(const url of tryUrls){ try{ const r = await fetch(url, { cache:'no-store' }); if(r.ok){ fetchedText = await r.text(); break; } } catch(err){ console.warn('dicebear fetch failed', err); } } if(!fetchedText) throw new Error('Failed to fetch SVG'); const info = extractInnerSvgInfo(fetchedText, outSize); innerSvg = info.innerSvg; innerW = info.w; innerH = info.h; }
    const maxInner = Math.max(innerW, innerH) || outSize; const fillScale = outSize / maxInner; const totalScale = fillScale * userScale; const cx = outSize/2; const cy = outSize/2; const transform = `translate(${cx}, ${cy}) rotate(${rotation}) scale(${totalScale}) translate(${-innerW/2}, ${-innerH/2})`; const rectFilterAttr = noiseFilterId ? ` filter="url(#${noiseFilterId})"` : ''; const svg = `\n<svg xmlns="http://www.w3.org/2000/svg" width="${outSize}" height="${outSize}" viewBox="0 0 ${outSize} ${outSize}" preserveAspectRatio="xMidYMid slice" role="img" aria-label="Monadicon">\n  <defs>${defs}</defs>\n  <rect width="${outSize}" height="${outSize}" fill="${rectFill}" ${rectFilterAttr} />\n  <g transform="${transform}">${innerSvg}</g>\n</svg>`; return svg; }

    // Render preview
    async function renderPreview(settings, addToHistory=false){ previewBox.innerHTML = `<div style="color:var(--muted);text-align:center">Rendering...</div>`; try{ const finalSvg = await buildFinalSvg(settings); previewBox.innerHTML = finalSvg; if(placeholder) placeholder.style.display='none'; previewMeta.textContent = `${settings.style} • ${settings.seed} • ${settings.size}px`; settingsOut.textContent = JSON.stringify(settings, null, 2); updateAutoDescriptionFromRendered(finalSvg, settings); updateBadgeVisibility(); if(addToHistory){ history.unshift({ settings, svg: finalSvg }); if(history.length > 28) history.pop(); renderHistory(); confetti(); showToast('Generated and added to history'); } else { showToast('Preview applied'); } }catch(e){ previewBox.innerHTML = `<div style="color:#ff6b6b;font-weight:700">Error rendering preview</div><div style="color:var(--muted);margin-top:8px">Check console for details.</div>`; console.error('Preview error:', e); showToast('Preview error — check console'); } }

    function renderHistory(){ historyEl.innerHTML=''; for(const item of history){ const thumb = document.createElement('div'); thumb.className='thumb'; thumb.title = `${item.settings.seed || 'composite'} • ${item.settings.style}`; const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(item.svg))); thumb.appendChild(img); thumb.onclick = ()=>{ loadSettings(item.settings); previewBox.innerHTML = item.svg; updateAutoDescriptionFromRendered(item.svg, item.settings); updateBadgeVisibility(); showToast('Loaded from history'); }; historyEl.appendChild(thumb); } }

    function readSettingsFromUI(){ return { seed: seedEl.value || 'anon', style: styleEl.value, size: parseInt(sizeEl.value) || 512, scale: parseFloat(scaleEl.value) || 100, rotation: parseFloat(rotationEl.value) || 0, bgType: bgTypeEl.value, bgColor: bgColorEl.value || '#7C3AED' }; }
    function loadSettings(s){ seedEl.value = s.seed || 'anon'; styleEl.value = s.style || 'adventurer'; sizeEl.value = s.size || 512; scaleEl.value = s.scale || 100; rotationEl.value = s.rotation || 0; bgTypeEl.value = s.bgType || 'transparent'; bgColorEl.value = s.bgColor || '#7C3AED'; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2); }

    // Confetti (keeps the fun)
    function confetti(){ const canvas = document.createElement('canvas'); canvas.style.position='fixed'; canvas.style.left='0'; canvas.style.top='0'; canvas.style.pointerEvents='none'; canvas.width = innerWidth; canvas.height = innerHeight; document.body.appendChild(canvas); const ctx = canvas.getContext('2d'); const pieces = Array.from({length:80}, ()=>({ x: innerWidth/2 + (Math.random()-0.5)*200, y: innerHeight/2 + (Math.random()-0.5)*60, vx: (Math.random()-0.5)*8, vy: Math.random()*-10-2, r: Math.random()*6+3, c: `hsl(${Math.random()*360},80%,60%)`, rot: Math.random()*Math.PI })); (function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.4; p.rot+=0.2; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); if(p.y>canvas.height+50) pieces.splice(i,1); }); if(pieces.length) requestAnimationFrame(anim); else canvas.remove(); })(); }

    // Badge handling
    function updateBadgeVisibility(){ if(!badgeOverlay) return; if(badgeToggle.checked){ const nameVal = (generatedNameEl.value && generatedNameEl.value.trim()) ? generatedNameEl.value.trim() : (seedEl.value || 'anon'); const rarity = computeRarity(nameVal); const emoji = rarity === 'Legendary' ? '🔥' : rarity === 'Epic' ? '✨' : rarity === 'Rare' ? '⭐' : rarity === 'Uncommon' ? '🔷' : '◻️'; badgeOverlay.style.display = 'block'; badgeOverlay.textContent = `${emoji} ${rarity}`; badgeOverlay.classList.remove('badge-epic','badge-legendary'); if(rarity === 'Epic') badgeOverlay.classList.add('badge-epic'); if(rarity === 'Legendary') badgeOverlay.classList.add('badge-legendary'); } else { badgeOverlay.style.display = 'none'; } }
    function playBadgeAnimation(){ if(!badgeOverlay) return; badgeOverlay.classList.remove('badge-animate'); void badgeOverlay.offsetWidth; badgeOverlay.classList.add('badge-animate'); setTimeout(()=>{ badgeOverlay.classList.remove('badge-animate'); }, 900); }

    // Name UI interactions
    function genBtnHandler(){ const det = deterministicNameCheckbox.checked; const name = generateRandomName(det); generatedNameEl.value = name; showToast('Name generated'); const colors = generatePaletteFromSeed(name); renderPalette(colors); updateBadgeVisibility(); playBadgeAnimation(); }
    genNameBtn.addEventListener('click', genBtnHandler); generateNameBtn && generateNameBtn.addEventListener('click', genBtnHandler);

    copyNameBtn.addEventListener('click', async ()=>{ const val = generatedNameEl.value && generatedNameEl.value.trim(); if(!val){ showToast('No name to copy'); return; } try{ await navigator.clipboard.writeText(val); showToast('Name copied'); } catch{ showToast('Copy failed'); } });
    applyNameAsSeedBtn.addEventListener('click', ()=>{ const v = generatedNameEl.value && generatedNameEl.value.trim(); if(!v){ showToast('No name to apply'); return; } seedEl.value = v; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2); if(liveToggle.checked) applyPreviewBtn.click(); showToast('Applied name as seed'); });
    badgeToggle.addEventListener('change', updateBadgeVisibility);

    // Generate + preview
    generateBtn.addEventListener('click', async ()=>{ try{ if(autoNameOnGenerateCheckbox && autoNameOnGenerateCheckbox.checked){ const det = deterministicNameCheckbox.checked; const name = generateRandomName(det); generatedNameEl.value = name; const colors = generatePaletteFromSeed(name); renderPalette(colors); updateBadgeVisibility(); playBadgeAnimation(); } }catch(e){ console.warn('Auto-name failed', e); }
      const s = readSettingsFromUI(); if(generatedNameEl.value && generatedNameEl.value.trim()) s.seed = generatedNameEl.value.trim(); await renderPreview(s, true); });

    applyPreviewBtn.addEventListener('click', async ()=>{ const s = readSettingsFromUI(); if(generatedNameEl.value && generatedNameEl.value.trim()) s.seed = generatedNameEl.value.trim(); await renderPreview(s, false); });

    applyPromptBtn.addEventListener('click', ()=>{ const p = (promptEl.value || '').trim(); if(!p){ showToast('Please enter a prompt'); return; } seedEl.value = p; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2); if(promptUseAsSeedEl.checked && liveToggle.checked) applyPreviewBtn.click(); });

    generateFromPromptBtn.addEventListener('click', async ()=>{ const p = (promptEl.value||'').trim(); if(!p){ showToast('Please enter a prompt'); return; } const seedFromPrompt = promptUseAsSeedEl.checked ? p : slugifyPrompt(p); seedEl.value = seedFromPrompt; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null,2); const s = readSettingsFromUI(); await renderPreview(s, true); });

    promptUseAsSeedEl.addEventListener('change', ()=>{ if(promptUseAsSeedEl.checked){ const p = (promptEl.value||'').trim(); if(p) seedEl.value = p; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null,2); if(liveToggle.checked) applyPreviewBtn.click(); } });

    promptEl.addEventListener('input', ()=>{ if(promptUseAsSeedEl.checked){ const p=(promptEl.value||'').trim(); if(p) seedEl.value = p; settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null,2); if(liveToggle.checked){ if(window._liveTimeout) clearTimeout(window._liveTimeout); window._liveTimeout = setTimeout(()=>{ applyPreviewBtn.click(); }, 300); } } });

    // Downloads & clipboard
    downloadSvgBtn.addEventListener('click', async ()=>{ try{ const curSvg = previewBox.querySelector('svg'); const base = (generatedNameEl.value && generatedNameEl.value.trim()) ? generatedNameEl.value.trim().replace(/\s+/g,'_') : (seedEl.value || 'monadicon'); if(curSvg){ const svgText = new XMLSerializer().serializeToString(curSvg); downloadSVGfromString(svgText, `${base}.svg`); showToast('SVG downloaded'); return; } const s = readSettingsFromUI(); const svg = await buildFinalSvg(s); downloadSVGfromString(svg, `${base}.svg`); showToast('SVG downloaded'); }catch(e){ showToast('SVG download failed'); console.error(e); } });

    downloadPngBtn.addEventListener('click', async ()=>{ try{ const curSvg = previewBox.querySelector('svg'); const base = (generatedNameEl.value && generatedNameEl.value.trim()) ? generatedNameEl.value.trim().replace(/\s+/g,'_') : (seedEl.value || 'monadicon'); if(curSvg){ const svgText = new XMLSerializer().serializeToString(curSvg); downloadPNGfromSvgString(svgText, `${base}.png`); showToast('PNG download started'); return; } const s = readSettingsFromUI(); const svg = await buildFinalSvg(s); downloadPNGfromSvgString(svg, `${base}.png`); showToast('PNG download started'); }catch(e){ showToast('PNG creation failed'); console.error(e); } });

    copyEmbedBtn.addEventListener('click', async ()=>{ try{ const curSvg = previewBox.querySelector('svg'); const svgText = curSvg ? new XMLSerializer().serializeToString(curSvg) : await buildFinalSvg(readSettingsFromUI()); await navigator.clipboard.writeText(svgText); showToast('SVG embed copied'); }catch(e){ console.error('copy embed failed', e); showToast('Copy failed'); } });

    // share helpers (same as previous working version)
    async function svgStringToPngBlob(svgString, size=512){ return new Promise((resolve,reject)=>{ const img=new Image(); img.onload=()=>{ try{ const canvas=document.createElement('canvas'); canvas.width=img.width||size; canvas.height=img.height||size; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); canvas.toBlob((blob)=>{ if(blob) resolve(blob); else reject(new Error('toBlob gave null')); }, 'image/png'); }catch(err){ reject(err); } }; img.onerror=(e)=>reject(e); img.src='data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))); }); }

    async function copySvgAndPngToClipboard(svgString){ try{ const pngBlob = await svgStringToPngBlob(svgString); const clipboardItems = [ new ClipboardItem({ 'image/png': pngBlob, 'image/svg+xml': new Blob([svgString], { type:'image/svg+xml' }) }) ]; await navigator.clipboard.write(clipboardItems); return { ok:true, method:'image+svg' }; }catch(err){ try{ await navigator.clipboard.writeText(svgString); return { ok:true, method:'text' }; }catch(e2){ console.error('clipboard fallback failed', e2); return { ok:false }; } } }

    document.getElementById('shareX').addEventListener('click', async ()=>{ try{ const curSvgNode = previewBox.querySelector('svg'); const svgText = curSvgNode ? new XMLSerializer().serializeToString(curSvgNode) : await buildFinalSvg(readSettingsFromUI()); const meta = regenDescBtn._meta && regenDescBtn._meta.meta ? regenDescBtn._meta.meta : null; const name = (generatedNameEl.value && generatedNameEl.value.trim()) ? generatedNameEl.value.trim() : (seedEl.value || 'Monadicon'); const description = meta ? (meta.description || '') : `${name} — generated with Monadicons`; const copied = await copySvgAndPngToClipboard(svgText); if(copied.ok){ const tweetText = `${name}\n\n${(description || '').split('\n')[0]} \n\n#Monadicons`; const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`; window.open(url, '_blank', 'noopener'); showToast(copied.method==='image+svg' ? 'Image copied — paste into your tweet' : 'SVG copied — paste into your tweet'); } else { showToast('Copy failed — try download then upload'); } }catch(err){ console.error('shareX error', err); showToast('Share to X failed'); } });

    document.getElementById('shareDiscord').addEventListener('click', async ()=>{ try{ const curSvgNode = previewBox.querySelector('svg'); const svgText = curSvgNode ? new XMLSerializer().serializeToString(curSvgNode) : await buildFinalSvg(readSettingsFromUI()); const copied = await copySvgAndPngToClipboard(svgText); if(copied.ok){ window.open('https://discord.com/channels/@me', '_blank', 'noopener'); showToast(copied.method==='image+svg' ? 'Image copied — paste into Discord' : 'SVG copied — paste into Discord'); } else { showToast('Copy failed — try download then upload'); } }catch(err){ console.error('shareDiscord error', err); showToast('Share to Discord failed'); } });

    // regenerate description
    regenDescBtn.addEventListener('click', async ()=>{ try{ const curSvgNode = previewBox.querySelector('svg'); if(curSvgNode){ const svgText = new XMLSerializer().serializeToString(curSvgNode); const settings = readSettingsFromUI(); updateAutoDescriptionFromRendered(svgText, settings); showToast('Description regenerated from preview'); return; } const s = readSettingsFromUI(); if(generatedNameEl.value && generatedNameEl.value.trim()) s.seed = generatedNameEl.value.trim(); const svg = await buildFinalSvg(s); updateAutoDescriptionFromRendered(svg, s); showToast('Description regenerated (rebuilt)'); }catch(e){ console.error('Regenerate failed', e); showToast('Regenerate failed — see console'); } });

    copyDescBtn.addEventListener('click', ()=>{ const meta = copyDescBtn._meta; if(meta && meta.meta && meta.meta.description){ navigator.clipboard.writeText(meta.meta.description).then(()=>showToast('Description copied')).catch(()=>showToast('Copy failed')); return; } const txt = autoDescEl.textContent || ''; if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('Description copied')).catch(()=>showToast('Copy failed')); } else showToast('No description available'); });

    downloadMetaBtn.addEventListener('click', ()=>{ const meta = downloadMetaBtn._meta; if(!meta || !meta.meta){ showToast('Generate an icon first'); return; } const metadata = { name: meta.meta.name, description: meta.meta.description, attributes: meta.meta.attributes, image: 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(meta.svg))) }; const txt = JSON.stringify(metadata, null, 2); const blob = new Blob([txt], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${meta.meta.name.replace(/\s+/g,'_')}-metadata.json`; a.click(); URL.revokeObjectURL(url); showToast('Metadata JSON downloaded'); });

    // helper downloads
    function downloadSVGfromString(svgString, filename='monadicon.svg'){ const blob = new Blob([svgString], { type:'image/svg+xml' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
    function downloadPNGfromSvgString(svgString, filename='monadicon.png'){ const img = new Image(); img.onload = ()=>{ const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0); canvas.toBlob((blob)=>{ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }, 'image/png'); }; img.onerror = e => { showToast('PNG conversion failed'); console.error(e); }; img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))); }

    // presets & UI wiring
    document.querySelectorAll('.preset').forEach(btn=>{ btn.addEventListener('click', ()=>{ const seed = btn.dataset.seed; const style = btn.dataset.style; if(seed) seedEl.value = seed; if(style) styleEl.value = style; if(liveToggle.checked) applyPreviewBtn.click(); }); });
    randomPreset.addEventListener('click', ()=> randomBtn.click());

    exportJSON.addEventListener('click', ()=>{ try{ const settings = readSettingsFromUI(); const jsonText = JSON.stringify(settings, null, 2); const filename = `monadicon-settings-${Date.now()}.json`; const blob = new Blob([jsonText], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); navigator.clipboard?.writeText(jsonText).catch(()=>{}); showToast('Settings exported and copied'); }catch(e){ console.error(e); showToast('Export failed'); } });

    copyJSON.addEventListener('click', ()=>{ navigator.clipboard.writeText(JSON.stringify(readSettingsFromUI(), null, 2)); showToast('Settings JSON copied'); });
    downloadJSON.addEventListener('click', ()=>{ const txt = JSON.stringify(readSettingsFromUI(), null, 2); const blob = new Blob([txt], { type:'application/json' }); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='monadicon-settings.json'; a.click(); showToast('Settings JSON downloaded'); });

    clearHistory.addEventListener('click', ()=>{ history=[]; renderHistory(); showToast('History cleared'); });

    toggleThemeBtn.addEventListener('click', ()=> setTheme(!isLight));
    randomBtn.addEventListener('click', ()=>{ seedEl.value = sampleSeeds[Math.floor(Math.random()*sampleSeeds.length)] + '-' + Math.floor(Math.random()*9999); const styles = Array.from(document.querySelectorAll('#style option')).map(o=>o.value); styleEl.value = styles[Math.floor(Math.random()*styles.length)]; bgTypeEl.value = ['transparent','solid','gradient','radial','dots','stripes','checker','noise'][Math.floor(Math.random()*8)]; bgColorEl.value = '#' + Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0'); sizeEl.value = [128,256,512,768,1024][Math.floor(Math.random()*5)]; scaleEl.value = 80 + Math.floor(Math.random()*60); rotationEl.value = Math.floor(Math.random()*360)-180; if(liveToggle.checked) applyPreviewBtn.click(); });

    regenDescBtn._meta = null;

    // live preview wiring
    function setupLivePreview(){ const inputs = [seedEl, styleEl, sizeEl, scaleEl, rotationEl, bgTypeEl, bgColorEl]; inputs.forEach(inp=>{ inp.addEventListener('input', ()=>{ settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2); if(liveToggle.checked){ if(window._liveTimeout) clearTimeout(window._liveTimeout); window._liveTimeout = setTimeout(()=>{ applyPreviewBtn.click(); }, 300); } }); }); }

    // theme + tiny logo sparkle
    let isLight = false;
    function setTheme(light){ isLight = !!light; if(isLight){ document.body.style.background = 'linear-gradient(180deg,#f6f8fb,#e9f1f8)'; toggleThemeBtn.textContent='Dark'; } else { document.body.style.background = 'radial-gradient(800px 400px at 10% 10%, rgba(124,58,237,0.08), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2))'; toggleThemeBtn.textContent='Light'; } try{ localStorage.setItem('monadicons:theme', isLight? 'light':'dark'); }catch(e){} }

    // small logo animation on hover (already in css) + subtle periodic pulse
    const logo = document.getElementById('logo'); setInterval(()=>{ logo.animate([{ transform:'scale(1)' },{ transform:'scale(1.03)' },{ transform:'scale(1)' }], { duration: 2500, easing: 'ease-in-out' }); }, 4200);

    // init
    setupLivePreview(); try{ const p = localStorage.getItem('monadicons:theme'); setTheme(p === 'light'); }catch(e){ setTheme(false); }
    settingsOut.textContent = JSON.stringify(readSettingsFromUI(), null, 2);
    applyPreviewBtn.click();
  </script>
</body>
</html>
